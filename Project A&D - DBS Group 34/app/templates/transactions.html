{% extends "logged_in_base.html" %}
{% from "macros.html" import action_buttons %}

{% block sub_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/transactions.css') }}">

<div class="card">
    <!-- Header Section -->
    <div class="transactions-header">
        <h2 class="transactions-title">Huidige transacties</h2>
        <div class="transactions-header-right">
            {{ action_buttons("Transactie", "addTransactionForm", "openEditTransactionModal", "openDeleteTransactionModal", "+ Transactie") }}
        </div>
    </div>

    <!-- Add Transaction Form -->
    <div id="addTransactionForm" style="display:none; margin-top:20px; padding:20px; background:#f5f5f5; border-radius:8px;">
        <h3 style="margin-bottom:15px;">Nieuwe Transactie Toevoegen</h3>
        <form method="POST" action="{{ url_for('main.add_transaction') }}" class="inline-form">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Datum *</label>
                    <input type="text" name="transaction_date" placeholder="dd/mm/yyyy (bijv. 01/09/2022)" required>
                </div>
                <div class="form-group">
                    <label>Transactie Type *</label>
                    <select name="transaction_type" required>
                        <option value="">Selecteer...</option>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Asset Naam *</label>
                    <input type="text" name="asset_name" placeholder="Bijv. Microsoft Corporation" required>
                </div>
                <div class="form-group">
                    <label>Ticker *</label>
                    <input type="text" name="transaction_ticker" placeholder="Bijv. MSFT" required>
                </div>
                <div class="form-group">
                    <label>Hoeveelheid (Quantity) *</label>
                    <input type="number" step="0.01" name="transaction_quantity" placeholder="Bijv. 10" required>
                </div>
                <div class="form-group">
                    <label>Prijs per Aandeel (Price) *</label>
                    <input type="number" step="0.01" name="transaction_share_price" placeholder="Bijv. 242.80" required>
                </div>
                <div class="form-group">
                    <label>Currency *</label>
                    <select name="transaction_currency" required>
                        <option value="EUR">EUR</option>
                        <option value="USD">USD</option>
                        <option value="CAD">CAD</option>
                        <option value="DKK">DKK</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Asset Class *</label>
                    <select name="asset_class" required>
                        <option value="Stock">Stock</option>
                        <option value="Bond">Bond</option>
                        <option value="ETF">ETF</option>
                        <option value="Crypto">Crypto</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sector</label>
                    <select name="sector">
                        <option value="">Selecteer sector...</option>
                        <option value="Tech">Tech</option>
                        <option value="Ind., E. & R.M.">Ind., E. & R.M.</option>
                        <option value="Cons. & Health">Cons. & Health</option>
                        <option value="RE, F. & Hold.">RE, F. & Hold.</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Transaction Amount</label>
                    <input type="number" step="0.01" name="transaction_amount" placeholder="Wordt automatisch berekend (quantity * price)" readonly id="total_amount_calc">
                    <small style="color: #666; font-size: 0.85em;">Wordt automatisch berekend</small>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="submit" class="btn">Transactie Toevoegen</button>
                <button type="button" class="btn ghost" onclick="document.getElementById('addTransactionForm').style.display='none'">Annuleren</button>
            </div>
        </form>
    </div>
    
    <script>
    // Auto-calculate total transaction amount
    function setupTotalCalculation() {
        const form = document.getElementById('addTransactionForm');
        if (!form) return;
        
        const quantityInput = form.querySelector('input[name="transaction_quantity"]');
        const priceInput = form.querySelector('input[name="transaction_share_price"]');
        const totalInput = document.getElementById('total_amount_calc');
        
        function calculateTotal() {
            if (quantityInput && priceInput && totalInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                totalInput.value = total.toFixed(2);
            }
        }
        
        if (quantityInput) {
            quantityInput.removeEventListener('input', calculateTotal);
            quantityInput.addEventListener('input', calculateTotal);
        }
        if (priceInput) {
            priceInput.removeEventListener('input', calculateTotal);
            priceInput.addEventListener('input', calculateTotal);
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        setupTotalCalculation();
        
        // Setup calculation when form is shown
        const addBtn = document.querySelector('.add-transaction-btn');
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                setTimeout(setupTotalCalculation, 100);
            });
        }
    });
    </script>

    <!-- Edit Transaction Modal (stap 1: nummer invoeren) -->
    <div id="editTransactionModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h2>Transactie Bewerken</h2>
                <span class="modal-close" onclick="closeEditTransactionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm" onsubmit="fetchTransactionForEditing(event)">
                    <div class="form-group">
                        <label>Transactie Nummer *</label>
                        <input type="number" min="1" name="transaction_number" id="editTransactionNumberInput" required placeholder="Bijv. 1, 2, 3...">
                        <small style="color: #666; font-size: 12px;">Voer het nummer in van de transactie die je wilt bewerken (zie de eerste kolom in de tabel)</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Volgende</button>
                        <button type="button" class="btn ghost" onclick="closeEditTransactionModal()">Annuleren</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Form Modal (stap 2: formulier) -->
    <div id="editTransactionFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2>Transactie Bewerken</h2>
                <span class="modal-close" onclick="closeEditTransactionFormModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--muted); font-size: 14px;">Pas de transactie aan.</p>
                <form id="editTransactionFormSubmit" method="POST" action="{{ url_for('main.update_transaction') }}">
                    <input type="hidden" name="transaction_id" id="editTransactionId">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum *</label>
                            <input type="text" name="transaction_date" id="editTransactionDate" required placeholder="dd/mm/yyyy" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Transactie Type *</label>
                            <select name="transaction_type" id="editTransactionType" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                                <option value="">Selecteer...</option>
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Asset Naam *</label>
                            <input type="text" name="asset_name" id="editAssetName" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Ticker *</label>
                            <input type="text" name="transaction_ticker" id="editTransactionTicker" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Hoeveelheid (Quantity) *</label>
                            <input type="number" step="0.01" name="transaction_quantity" id="editTransactionQuantity" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Prijs per Aandeel (Price) *</label>
                            <input type="number" step="0.01" name="transaction_share_price" id="editTransactionSharePrice" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Currency *</label>
                            <select name="transaction_currency" id="editTransactionCurrency" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                                <option value="EUR">EUR</option>
                                <option value="USD">USD</option>
                                <option value="CAD">CAD</option>
                                <option value="DKK">DKK</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Asset Class *</label>
                            <select name="asset_class" id="editAssetClass" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                                <option value="Stock">Stock</option>
                                <option value="Bond">Bond</option>
                                <option value="ETF">ETF</option>
                                <option value="Crypto">Crypto</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sector</label>
                            <select name="sector" id="editSector" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                                <option value="">Selecteer sector...</option>
                                <option value="Tech">Tech</option>
                                <option value="Ind., E. & R.M.">Ind., E. & R.M.</option>
                                <option value="Cons. & Health">Cons. & Health</option>
                                <option value="RE, F. & Hold.">RE, F. & Hold.</option>
                                <option value="ETF">ETF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Total Transaction Amount</label>
                            <input type="number" step="0.01" name="transaction_amount" id="editTransactionAmount" readonly style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; background: #f5f5f5;">
                            <small style="color: #666; font-size: 0.85em;">Wordt automatisch berekend</small>
                        </div>
                    </div>
                    <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn ghost" onclick="closeEditTransactionFormModal()">Annuleren</button>
                        <button type="submit" class="btn" style="background: #ff9800; color: white; padding: 10px 20px;">Opslaan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Transaction Modal (stap 1: nummer invoeren) -->
    <div id="deleteTransactionModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h2>Transactie Verwijderen</h2>
                <span class="modal-close" onclick="closeDeleteTransactionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="deleteTransactionForm" onsubmit="fetchTransactionForDeletion(event)">
                    <div class="form-group">
                        <label>Transactie Nummer *</label>
                        <input type="number" min="1" name="transaction_number" id="deleteTransactionNumberInput" required placeholder="Bijv. 1, 2, 3...">
                        <small style="color: #666; font-size: 12px;">Voer het nummer in van de transactie die je wilt verwijderen (zie de eerste kolom in de tabel)</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">Volgende</button>
                        <button type="button" class="btn ghost" onclick="closeDeleteTransactionModal()">Annuleren</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Transaction Confirmation Modal (stap 2: bevestiging) -->
    <div id="deleteTransactionConfirmModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:450px;">
            <div class="modal-header">
                <h2>Transactie Verwijderen</h2>
                <span class="modal-close" onclick="closeDeleteTransactionConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="deleteTransactionConfirmMessage" style="margin-bottom: 20px; font-size: 15px; line-height: 1.5;">
                    Weet je zeker dat je deze transactie wilt verwijderen? Wijzigingen zijn permanent en kunnen niet ongedaan gemaakt worden.
                </p>
                <form id="deleteTransactionConfirmForm" method="POST" action="{{ url_for('main.delete_transaction') }}">
                    <input type="hidden" name="transaction_id" id="deleteTransactionId">
                    <div class="form-actions">
                        <button type="button" class="btn ghost" onclick="closeDeleteTransactionConfirmModal()">Annuleren</button>
                        <button type="submit" class="btn" style="background: #d32f2f; color: white;">Bevestigen</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Filter/Sort Section -->
    <div class="filter-section">
        <span class="filter-label">Sorteren/Filteren:</span>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="recent" onclick="toggleFilter('recent')">Recent</button>
            <button class="filter-btn" data-filter="past" onclick="toggleFilter('past')">Past</button>
            <button class="filter-btn" data-filter="buy" onclick="toggleFilter('buy')">Buy</button>
            <button class="filter-btn" data-filter="sell" onclick="toggleFilter('sell')">Sell</button>
            <div class="sector-dropdown-wrapper">
                <button class="filter-btn" data-filter="sector" id="sectorFilterBtn" onclick="toggleSectorDropdown(event)">Sector</button>
                <div class="sector-dropdown" id="sectorDropdown" style="display: none;">
                    <div class="sector-option" onclick="selectSector('')">Alle sectoren</div>
                    <div class="sector-option" onclick="selectSector('Tech')">Tech</div>
                    <div class="sector-option" onclick="selectSector('Ind., E. & R.M.')">Ind., E. & R.M.</div>
                    <div class="sector-option" onclick="selectSector('Cons. & Health')">Cons. & Health</div>
                    <div class="sector-option" onclick="selectSector('RE, F. & Hold.')">RE, F. & Hold.</div>
                    <div class="sector-option" onclick="selectSector('ETF')">ETF</div>
                </div>
            </div>
            <button class="filter-btn" data-filter="size" onclick="toggleFilter('size')">Transactie grootte</button>
            <button class="filter-btn" data-filter="shares" onclick="toggleFilter('shares')">Aantal aandelen</button>
            <button class="filter-btn" data-filter="stock" onclick="toggleFilter('stock')">Stock</button>
            <button class="filter-btn" data-filter="etf" onclick="toggleFilter('etf')">ETF</button>
        </div>
    </div>
    
    <!-- Horizontal Scrollbar Spacer -->
    <div class="scrollbar-spacer"></div>

    <!-- Transactions Table -->
    <div class="transactions-table-wrapper">
        <table class="transactions-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>DATE</th>
                    <th>ASSET</th>
                    <th>TICKER</th>
                    <th>SECTOR</th>
                    <th>TRANSACTION TYPE</th>
                    <th>QUANTITY</th>
                    <th>PRICE</th>
                    <th>TOTAL TRANSACTION AMOUNT</th>
                    <th>CURRENCY</th>
                    <th>ASSET CLASS</th>
                </tr>
            </thead>
            <tbody>
                {% if transactions %}
                    {% for t in transactions %}
                    <tr data-date="{{ t.date }}" 
                        data-type="{{ t.type }}"
                        data-total-amount="{{ t.total_value or 0 }}"
                        data-total-amount-eur="{{ t.total_value_eur or 0 }}"
                        data-quantity="{{ t.units or 0 }}"
                        data-ticker="{{ t.ticker or '' }}"
                        data-sector="{{ t.sector or 'Unknown' }}"
                        data-asset-class="{{ t.asset_class or 'Stock' }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ t.date }}</td>
                        <td>
                            {% if t.exchange and t.ticker %}
                                {{ t.asset_name }} ({{ t.exchange }}:{{ t.ticker }})
                            {% else %}
                                {{ t.asset_name or t.asset or 'Onbekend' }}
                            {% endif %}
                        </td>
                        <td class="ticker">{{ t.ticker or '' }}</td>
                        <td>{{ t.sector or 'Unknown' }}</td>
                        <td class="{% if t.type == 'BUY' %}type-buy{% else %}type-sell{% endif %}">{{ t.type or '' }}</td>
                        <td>{{ "%.0f"|format(t.units) if t.units % 1 == 0 else "%.2f"|format(t.units) if t.units else '0' }}</td>
                        <td>{{ t.price or '0,00' }} {{ t.currency or 'EUR' }}</td>
                        <td>{{ t.total or '0,00' }} {{ t.currency or 'EUR' }}</td>
                        <td>{{ t.currency or 'EUR' }}</td>
                        <td>{{ t.asset_class or 'Stock' }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px; color: var(--muted);">
                            Geen transacties gevonden. Controleer de console voor debug informatie.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
let allTransactions = [];
let activeFilters = {
    sortDate: 'recent',  // 'recent' of 'past'
    sortMethod: null,    // 'size' of 'shares' of null
    transactionType: null, // 'buy' of 'sell' of null
    assetClass: null,    // 'stock' of 'etf' of null
    sector: null         // null of sector name (e.g. 'Tech', 'Cons. & Health')
};

// Define exclusive filter groups (filters that cannot be combined within the same group)
const exclusiveGroups = {
    sortDate: ['recent', 'past'],
    sortMethod: ['size', 'shares'],
    transactionType: ['buy', 'sell'],
    assetClass: ['stock', 'etf']
};

// Parse date string (format: "d-m-Y" like "1-9-2022") to comparable date
function parseDate(dateStr) {
    const parts = dateStr.split('-');
    if (parts.length !== 3) return new Date(0);
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1; // JavaScript months are 0-indexed
    const year = parseInt(parts[2], 10);
    return new Date(year, month, day);
}

// Store all transactions on page load
document.addEventListener('DOMContentLoaded', function() {
    const rows = Array.from(document.querySelectorAll('.transactions-table tbody tr'));
    allTransactions = rows.map(row => ({
        element: row,
        date: row.getAttribute('data-date') || '',
        type: row.getAttribute('data-type') || '',
        totalAmount: parseFloat(row.getAttribute('data-total-amount') || 0),
        totalAmountEUR: parseFloat(row.getAttribute('data-total-amount-eur') || 0),
        quantity: parseFloat(row.getAttribute('data-quantity') || 0),
        ticker: row.getAttribute('data-ticker') || '',
        sector: row.getAttribute('data-sector') || 'Unknown',
        assetClass: row.getAttribute('data-asset-class') || 'Stock'
    }));
    
    // Set default filter to 'recent'
    if (allTransactions.length > 0) {
        updateFilterButtons();
        applyFilters();
    }
});

function toggleFilter(filterType) {
    // Determine which group this filter belongs to
    let group = null;
    let currentValue = null;
    
    for (const [groupName, filters] of Object.entries(exclusiveGroups)) {
        if (filters.includes(filterType)) {
            group = groupName;
            break;
        }
    }
    
    // Handle exclusive groups (sector is now handled separately via dropdown)
    if (group) {
        // Handle exclusive groups
        if (group === 'sortDate') {
            if (activeFilters.sortDate === filterType) {
                // Don't allow unchecking the date sort (always need one)
                return;
            }
            activeFilters.sortDate = filterType;
        } else if (group === 'sortMethod') {
            if (activeFilters.sortMethod === filterType) {
                // Allow unchecking
                activeFilters.sortMethod = null;
            } else {
                activeFilters.sortMethod = filterType;
            }
        } else if (group === 'transactionType') {
            if (activeFilters.transactionType === filterType) {
                activeFilters.transactionType = null;
            } else {
                activeFilters.transactionType = filterType;
            }
        } else if (group === 'assetClass') {
            if (activeFilters.assetClass === filterType) {
                activeFilters.assetClass = null;
            } else {
                activeFilters.assetClass = filterType;
            }
        }
    }
    
    // Update button states
    updateFilterButtons();
    
    // Apply filters
    applyFilters();
}

function updateFilterButtons() {
    // Update all filter buttons based on activeFilters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        const filterType = btn.getAttribute('data-filter');
        if (!filterType) return;
        
        btn.classList.remove('active');
        
        if (filterType === 'recent' && activeFilters.sortDate === 'recent') {
            btn.classList.add('active');
        } else if (filterType === 'past' && activeFilters.sortDate === 'past') {
            btn.classList.add('active');
        } else if (filterType === 'buy' && activeFilters.transactionType === 'buy') {
            btn.classList.add('active');
        } else if (filterType === 'sell' && activeFilters.transactionType === 'sell') {
            btn.classList.add('active');
        } else if (filterType === 'stock' && activeFilters.assetClass === 'stock') {
            btn.classList.add('active');
        } else if (filterType === 'etf' && activeFilters.assetClass === 'etf') {
            btn.classList.add('active');
        } else if (filterType === 'size' && activeFilters.sortMethod === 'size') {
            btn.classList.add('active');
        } else if (filterType === 'shares' && activeFilters.sortMethod === 'shares') {
            btn.classList.add('active');
        } else if (filterType === 'sector' && activeFilters.sector !== null) {
            btn.classList.add('active');
        }
    });
}

function applyFilters() {
    const tbody = document.querySelector('.transactions-table tbody');
    let filtered = [...allTransactions];
    
    // Apply transaction type filter (buy/sell)
    if (activeFilters.transactionType === 'buy') {
        filtered = filtered.filter(t => t.type === 'BUY');
    } else if (activeFilters.transactionType === 'sell') {
        filtered = filtered.filter(t => t.type === 'SELL');
    }
    
    // Apply asset class filter (stock/etf)
    if (activeFilters.assetClass === 'stock') {
        filtered = filtered.filter(t => {
            const assetClass = (t.assetClass || 'Stock').toUpperCase();
            return assetClass === 'STOCK';
        });
    } else if (activeFilters.assetClass === 'etf') {
        filtered = filtered.filter(t => {
            const assetClass = (t.assetClass || 'Stock').toUpperCase();
            return assetClass === 'ETF';
        });
    }
    
    // Apply sector filter
    if (activeFilters.sector !== null && activeFilters.sector !== '') {
        filtered = filtered.filter(t => {
            const transactionSector = (t.sector || 'Unknown').trim();
            return transactionSector === activeFilters.sector || 
                   transactionSector.toUpperCase() === activeFilters.sector.toUpperCase();
        });
    }
    
    // Apply sorting
    if (activeFilters.sortMethod === 'size') {
        // Sort by total transaction amount in EUR (highest first)
        filtered.sort((a, b) => {
            const aEUR = Math.abs(a.totalAmountEUR || 0);
            const bEUR = Math.abs(b.totalAmountEUR || 0);
            return bEUR - aEUR; // Hoogste eerst
        });
    } else if (activeFilters.sortMethod === 'shares') {
        // Sort by quantity (highest first)
        filtered.sort((a, b) => b.quantity - a.quantity);
    } else {
        // Default: sort by date (recent or past)
        if (activeFilters.sortDate === 'past') {
            filtered.sort((a, b) => parseDate(a.date) - parseDate(b.date));
        } else {
            // Default: recent (newest first)
            filtered.sort((a, b) => parseDate(b.date) - parseDate(a.date));
        }
    }
    
    // Clear tbody and re-add filtered rows
    tbody.innerHTML = '';
    filtered.forEach((transaction, index) => {
        const row = transaction.element.cloneNode(true);
        const numberCell = row.querySelector('td:first-child');
        if (numberCell) {
            numberCell.textContent = index + 1;
        }
        tbody.appendChild(row);
    });
}

// Legacy function for backwards compatibility
function filterTransactions(filterType) {
    toggleFilter(filterType);
}

// Sector dropdown functions
function toggleSectorDropdown(event) {
    if (event) {
        event.stopPropagation();
    }
    const dropdown = document.getElementById('sectorDropdown');
    const isVisible = dropdown.style.display !== 'none';
    
    // Close all other dropdowns
    document.querySelectorAll('.sector-dropdown').forEach(dd => {
        dd.style.display = 'none';
    });
    
    // Toggle current dropdown
    dropdown.style.display = isVisible ? 'none' : 'block';
}

function selectSector(sectorName) {
    activeFilters.sector = sectorName;
    
    // Update button text
    const btn = document.getElementById('sectorFilterBtn');
    if (sectorName === '') {
        btn.textContent = 'Sector';
        btn.classList.remove('active');
    } else {
        btn.textContent = `Sector: ${sectorName}`;
        btn.classList.add('active');
    }
    
    // Close dropdown
    document.getElementById('sectorDropdown').style.display = 'none';
    
    // Update filter buttons and apply filters
    updateFilterButtons();
    applyFilters();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdownWrapper = document.querySelector('.sector-dropdown-wrapper');
    const dropdown = document.getElementById('sectorDropdown');
    
    if (dropdownWrapper && !dropdownWrapper.contains(event.target)) {
        dropdown.style.display = 'none';
    }
});

// ============================================================================
// TRANSACTION EDIT/DELETE MODAL FUNCTIONALITY
// ============================================================================

// Edit Transaction Modal Functions
function openEditTransactionModal() {
    const modal = document.getElementById('editTransactionModal');
    modal.style.display = 'block';
    document.getElementById('editTransactionNumberInput').value = '';
    document.getElementById('editTransactionNumberInput').focus();
}

function closeEditTransactionModal() {
    document.getElementById('editTransactionModal').style.display = 'none';
    document.getElementById('editTransactionNumberInput').value = '';
}

function closeEditTransactionFormModal() {
    document.getElementById('editTransactionFormModal').style.display = 'none';
    closeEditTransactionModal();
}

async function fetchTransactionForEditing(event) {
    event.preventDefault();
    const transactionNumber = parseInt(document.getElementById('editTransactionNumberInput').value);
    
    if (!transactionNumber || transactionNumber < 1) {
        alert('Voer een geldig transactie nummer in.');
        return;
    }
    
    try {
        const response = await fetch(`/transactions/get-transaction/${transactionNumber}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // Fetch full transaction details
        const detailResponse = await fetch(`/transactions/get-transaction-details/${data.transaction_id}`);
        const detailData = await detailResponse.json();
        
        if (detailData.error) {
            alert(detailData.error);
            return;
        }
        
        // Fill form with transaction data
        document.getElementById('editTransactionId').value = detailData.transaction_id;
        document.getElementById('editTransactionDate').value = detailData.transaction_date || '';
        document.getElementById('editTransactionType').value = detailData.transaction_type || '';
        document.getElementById('editAssetName').value = detailData.asset_name || '';
        document.getElementById('editTransactionTicker').value = detailData.transaction_ticker || '';
        document.getElementById('editTransactionQuantity').value = detailData.transaction_quantity || '';
        document.getElementById('editTransactionSharePrice').value = detailData.transaction_share_price || '';
        document.getElementById('editTransactionCurrency').value = detailData.transaction_currency || 'EUR';
        document.getElementById('editAssetClass').value = detailData.asset_class || 'Stock';
        document.getElementById('editSector').value = detailData.sector || '';
        
        // Calculate and set total amount
        const quantity = parseFloat(detailData.transaction_quantity) || 0;
        const price = parseFloat(detailData.transaction_share_price) || 0;
        const total = quantity * price;
        document.getElementById('editTransactionAmount').value = total.toFixed(2);
        
        // Setup auto-calculation for edit form
        const qtyInput = document.getElementById('editTransactionQuantity');
        const priceInput = document.getElementById('editTransactionSharePrice');
        const totalInput = document.getElementById('editTransactionAmount');
        
        function calculateEditTotal() {
            const qty = parseFloat(qtyInput.value) || 0;
            const prc = parseFloat(priceInput.value) || 0;
            totalInput.value = (qty * prc).toFixed(2);
        }
        
        qtyInput.oninput = calculateEditTotal;
        priceInput.oninput = calculateEditTotal;
        
        // Close first modal and open form modal
        closeEditTransactionModal();
        document.getElementById('editTransactionFormModal').style.display = 'block';
    } catch (error) {
        console.error('Error fetching transaction:', error);
        alert('Fout bij ophalen van transactie informatie.');
    }
}

// Delete Transaction Modal Functions
function openDeleteTransactionModal() {
    const modal = document.getElementById('deleteTransactionModal');
    modal.style.display = 'block';
    document.getElementById('deleteTransactionNumberInput').value = '';
    document.getElementById('deleteTransactionNumberInput').focus();
}

function closeDeleteTransactionModal() {
    document.getElementById('deleteTransactionModal').style.display = 'none';
    document.getElementById('deleteTransactionNumberInput').value = '';
}

function closeDeleteTransactionConfirmModal() {
    document.getElementById('deleteTransactionConfirmModal').style.display = 'none';
    closeDeleteTransactionModal();
}

async function fetchTransactionForDeletion(event) {
    event.preventDefault();
    const transactionNumber = parseInt(document.getElementById('deleteTransactionNumberInput').value);
    
    if (!transactionNumber || transactionNumber < 1) {
        alert('Voer een geldig transactie nummer in.');
        return;
    }
    
    try {
        const response = await fetch(`/transactions/get-transaction/${transactionNumber}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // Show confirmation modal
        document.getElementById('deleteTransactionId').value = data.transaction_id;
        document.getElementById('deleteTransactionConfirmMessage').textContent = 
            `Weet je zeker dat je deze transactie wilt verwijderen? Wijzigingen zijn permanent en kunnen niet ongedaan gemaakt worden.`;
        
        closeDeleteTransactionModal();
        document.getElementById('deleteTransactionConfirmModal').style.display = 'block';
    } catch (error) {
        console.error('Error fetching transaction:', error);
        alert('Fout bij ophalen van transactie informatie.');
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const editModal = document.getElementById('editTransactionModal');
    const editFormModal = document.getElementById('editTransactionFormModal');
    const deleteModal = document.getElementById('deleteTransactionModal');
    const confirmModal = document.getElementById('deleteTransactionConfirmModal');
    
    if (event.target == editModal) {
        closeEditTransactionModal();
    }
    if (event.target == editFormModal) {
        closeEditTransactionFormModal();
    }
    if (event.target == deleteModal) {
        closeDeleteTransactionModal();
    }
    if (event.target == confirmModal) {
        closeDeleteTransactionConfirmModal();
    }
};
</script>
{% endblock %}
