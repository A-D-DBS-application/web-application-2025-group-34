{% extends "logged_in_base.html" %}
{% from "macros.html" import action_buttons %}

{% block sub_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/transactions.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/deelnemers.css') }}">

<div class="card">
  <!-- Header Section -->
  <div class="transactions-header">
    <h2 class="transactions-title">Deelnemers</h2>
    <div class="transactions-header-right">
      {{ action_buttons("Deelnemer", "addMemberForm", "openEditMemberModal", "openDeleteMemberModal", "+ Deelnemer") }}
    </div>
  </div>

  <!-- Site-Admin Tabel -->
  <div class="member-section">
    <div class="section-head">
      <h3>Site-Admin</h3>
    </div>
    <table class="participants-table">
      <thead>
        <tr>
          <th>ID nummer</th>
          <th>Acc-password</th>
          <th>Naam</th>
          <th>Functie</th>
          <th>Startjaar</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for admin_member in admin_members %}
          <tr class="{% if loop.index % 2 == 0 %}even-row{% else %}odd-row{% endif %}">
            <td>{{ "%06d"|format(admin_member.member_id) }}</td>
            <td>****</td>
            <td>{{ admin_member.member_name or 'Onbekend' }}</td>
            <td>{{ admin_member.voting_right or 'Admin' }}</td>
            <td>{{ admin_member.join_date or admin_member.get_year() or '2025' }}</td>
            <td>{{ admin_member.email or '' }}</td>
          </tr>
        {% endfor %}
        {% if not admin_members %}
          <tr class="odd-row">
            <td colspan="6" class="empty-state">Geen Site-Admin gevonden</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Bestuur Tabel -->
  <div class="member-section">
    <div class="section-head">
      <h3>Bestuur</h3>
    </div>
    <table class="participants-table">
      <thead>
        <tr>
          <th>ID nummer</th>
          <th>Acc-password</th>
          <th>Naam</th>
          <th>Functie</th>
          <th>Startjaar</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for board_member in board_members %}
          <tr class="{% if loop.index % 2 == 0 %}even-row{% else %}odd-row{% endif %}">
            <td>{{ "%06d"|format(board_member.member_id) }}</td>
            <td>****</td>
            <td>{{ board_member.member_name or 'Onbekend' }}</td>
            <td>{{ board_member.get_board_function_name() or 'Bestuurslid' }}</td>
            <td>{{ board_member.get_year() or (board_member.created_at.strftime('%Y') if board_member.created_at else '2025') }}</td>
            <td>{{ board_member.email or '' }}</td>
          </tr>
        {% endfor %}
        {% if not board_members %}
          <tr class="odd-row">
            <td colspan="6" class="empty-state">Geen Bestuursleden gevonden</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Analisten Tabel -->
  <div class="member-section">
    <div class="section-head">
      <h3>Analisten</h3>
    </div>
    <table class="participants-table">
      <thead>
        <tr>
          <th>ID nummer</th>
          <th>Acc-password</th>
          <th>Naam</th>
          <th>Functie</th>
          <th>Sector</th>
          <th>Startjaar</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for analist in analisten %}
          <tr class="{% if loop.index % 2 == 0 %}even-row{% else %}odd-row{% endif %}">
            <td>{{ "%06d"|format(analist.member_id) }}</td>
            <td>****</td>
            <td>{{ analist.member_name or 'Onbekend' }}</td>
            <td>Analist</td>
            <td>
              {% set sector_num = analist.get_analist_sector() or (analist.sector|int if analist.sector and analist.sector.isdigit() else None) %}
              {% if sector_num == 1 %}
                Cons. & Health
              {% elif sector_num == 2 %}
                Ind., E. & R.M.
              {% elif sector_num == 3 %}
                RE, F. & Hold.
              {% elif sector_num == 4 %}
                Tech
              {% else %}
                Sector {{ sector_num or '' }}
              {% endif %}
            </td>
            <td>{{ analist.join_date or analist.get_year() or '2025' }}</td>
            <td>{{ analist.email or '' }}</td>
          </tr>
        {% endfor %}
        {% if not analisten %}
          <tr class="odd-row">
            <td colspan="7" class="empty-state">Geen Analisten gevonden</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Leden Tabel -->
  <div class="member-section">
    <div class="section-head">
      <h3>Leden</h3>
    </div>
    <table class="participants-table">
      <thead>
        <tr>
          <th>ID nummer</th>
          <th>Acc-password</th>
          <th>Naam</th>
          <th>Functie</th>
          <th>Startjaar</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for member in members %}
          <tr class="{% if loop.index % 2 == 0 %}even-row{% else %}odd-row{% endif %}">
            <td>{{ "%06d"|format(member.member_id) }}</td>
            <td>****</td>
            <td>{{ member.member_name or 'Onbekend' }}</td>
            <td>Lid</td>
            <td>{{ member.join_date or member.get_year() or '2025' }}</td>
            <td>{{ member.email or '' }}</td>
          </tr>
        {% endfor %}
        {% if not members %}
          <tr class="odd-row">
            <td colspan="6" class="empty-state">Geen Leden gevonden</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Kapitaalverschaffers Tabel -->
  {% if kapitaalverschaffers %}
  <div class="member-section">
    <div class="section-head">
      <h3>Kapitaalverschaffers</h3>
    </div>
    <table class="participants-table">
      <thead>
        <tr>
          <th>ID nummer</th>
          <th>Acc-password</th>
          <th>Naam</th>
          <th>Functie</th>
          <th>Startjaar</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for kv in kapitaalverschaffers %}
          <tr class="{% if loop.index % 2 == 0 %}even-row{% else %}odd-row{% endif %}">
            <td>{{ "%06d"|format(kv.member_id) }}</td>
            <td>****</td>
            <td>{{ kv.member_name or 'Onbekend' }}</td>
            <td>Kapitaalverschaffer</td>
            <td>{{ kv.join_date or kv.get_year() or '2025' }}</td>
            <td>{{ kv.email or '' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Oud-Bestuur en Oud-Analisten Tabel -->
  {% if oud_bestuur_analisten %}
  <div class="member-section">
    <div class="section-head">
      <h3>Oud-Bestuur en Oud-Analisten</h3>
    </div>
    <table class="participants-table">
      <thead>
        <tr>
          <th>ID nummer</th>
          <th>Acc-password</th>
          <th>Naam</th>
          <th>Functie</th>
          <th>Startjaar</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for oud in oud_bestuur_analisten %}
          <tr class="{% if loop.index % 2 == 0 %}even-row{% else %}odd-row{% endif %}">
            <td>{{ "%06d"|format(oud.member_id) }}</td>
            <td>****</td>
            <td>{{ oud.member_name or 'Onbekend' }}</td>
            <td>
              {% if oud.get_board_function_name() %}
                Oud-{{ oud.get_board_function_name() }}
              {% elif oud.get_analist_sector() %}
                {% set oud_sector_num = oud.get_analist_sector() %}
                {% if oud_sector_num == 1 %}
                  Oud-Analist (Cons. & Health)
                {% elif oud_sector_num == 2 %}
                  Oud-Analist (Ind., E. & R.M.)
                {% elif oud_sector_num == 3 %}
                  Oud-Analist (RE, F. & Hold.)
                {% elif oud_sector_num == 4 %}
                  Oud-Analist (Tech)
                {% else %}
                  Oud-Analist (Sector {{ oud_sector_num }})
                {% endif %}
              {% else %}
                Oud-Bestuurslid/Analist
              {% endif %}
            </td>
            <td>{{ oud.join_date or oud.get_year() or '2025' }}</td>
            <td>{{ oud.email or '' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>

<!-- Styles zijn verplaatst naar deelnemers.css -->

<!-- Add Member Modal -->
<div id="addMemberForm" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h2>Deelnemer Toevoegen</h2>
      <span class="modal-close" onclick="closeAddMemberModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p>Voeg een nieuwe deelnemer toe aan het systeem.</p>
      <form method="POST" action="{{ url_for('main.add_member') }}" id="addMemberFormSubmit">
        <div class="form-grid">
          <div class="form-group">
            <label>Rol *</label>
            <select name="role" id="addMemberRole" required onchange="updateFormFields()">
              <option value="lid">Lid</option>
              <option value="board">Bestuur</option>
              <option value="analist">Analist</option>
              <option value="kapitaalverschaffers">Kapitaalverschaffer</option>
            </select>
            <small style="color: #666; font-size: 12px;">ID nummer wordt automatisch gegenereerd</small>
          </div>
          <div class="form-group">
            <label>Naam *</label>
            <input type="text" name="member_name" id="addMemberName" required placeholder="Bijv. John Doe">
          </div>
          <div class="form-group">
            <label>Password *</label>
            <input type="password" name="password" id="addMemberPassword" required placeholder="Wachtwoord">
          </div>
          <div class="form-group" id="functionGroup" style="display: none;">
            <label>Functie *</label>
            <select name="voting_right" id="addMemberFunction">
              {% for func in board_functions %}
              <option value="{{ func.num }}">{{ func.display_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" id="addMemberEmail" placeholder="Bijv. john@example.com">
          </div>
          <div class="form-group" id="sectorGroup">
            <label>Sector</label>
            <select name="sector" id="addMemberSector">
              <option value="">Geen</option>
              <option value="1">Cons. & Health</option>
              <option value="2">Ind., E. & R.M.</option>
              <option value="3">RE, F. & Hold.</option>
              <option value="4">Tech</option>
            </select>
          </div>
          <div class="form-group">
            <label>Startjaar *</label>
            <input type="number" name="join_date" id="addMemberStartYear" required placeholder="Bijv. 2025" min="2000" max="2100" value="{{ current_year }}">
          </div>
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="btn ghost" onclick="closeAddMemberModal()">Annuleren</button>
          <button type="submit" class="add-transaction-btn">Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Member Modal (stap 1: ID invoeren) -->
<div id="editMemberModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <h2>Deelnemer Bewerken</h2>
      <span class="modal-close" onclick="closeEditMemberModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editMemberForm" onsubmit="fetchMemberForEditing(event)">
        <div class="form-group">
          <label>ID Nummer *</label>
          <input type="number" min="1" name="member_id" id="editMemberIdInput" required placeholder="Bijv. 000001">
          <small style="color: #666; font-size: 12px;">Voer het ID nummer in van de deelnemer die je wilt bewerken</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn">Volgende</button>
          <button type="button" class="btn ghost" onclick="closeEditMemberModal()">Annuleren</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Member Form Modal (stap 2: formulier) -->
<div id="editMemberFormModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h2>Deelnemer Bewerken</h2>
      <span class="modal-close" onclick="closeEditMemberFormModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p>Bewerk de gegevens van de deelnemer.</p>
      <form id="editMemberFormSubmit" method="POST" action="{{ url_for('main.update_member') }}">
        <input type="hidden" name="member_id" id="editMemberIdHidden">
        <div class="form-grid">
          <div class="form-group">
            <label>ID Nummer</label>
            <input type="text" id="editMemberIdDisplay" readonly class="readonly-input">
            <small>ID nummer kan niet worden gewijzigd</small>
          </div>
          <div class="form-group">
            <label>Naam *</label>
            <input type="text" name="member_name" id="editMemberName" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" name="password" id="editMemberPassword" placeholder="Laat leeg om niet te wijzigen">
          </div>
          <div class="form-group" id="editFunctionGroup">
            <label>Functie</label>
            <select name="voting_right" id="editMemberFunction">
              <option value="">Geen</option>
              {% for func in board_functions %}
              <option value="{{ func.num }}">{{ func.display_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" id="editMemberEmail">
          </div>
          <div class="form-group">
            <label>Sector</label>
            <select name="sector" id="editMemberSector">
              <option value="">Geen</option>
              <option value="1">Cons. & Health</option>
              <option value="2">Ind., E. & R.M.</option>
              <option value="3">RE, F. & Hold.</option>
              <option value="4">Tech</option>
            </select>
          </div>
          <div class="form-group">
            <label>Startjaar *</label>
            <input type="number" name="join_date" id="editMemberStartYear" required min="2000" max="2100">
          </div>
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="btn ghost" onclick="closeEditMemberFormModal()">Annuleren</button>
          <button type="submit" class="btn" style="background: #ff9800; color: white;">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Member Modal (stap 1: ID invoeren) -->
<div id="deleteMemberModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <h2>Deelnemer Verwijderen</h2>
      <span class="modal-close" onclick="closeDeleteMemberModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="deleteMemberForm" onsubmit="fetchMemberForDeletion(event)">
        <div class="form-group">
          <label>ID Nummer *</label>
          <input type="number" min="1" name="member_id" id="deleteMemberIdInput" required placeholder="Bijv. 000001">
          <small style="color: #666; font-size: 12px;">Voer het ID nummer in van de deelnemer die je wilt verwijderen</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn">Volgende</button>
          <button type="button" class="btn ghost" onclick="closeDeleteMemberModal()">Annuleren</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Member Confirmation Modal (stap 2: bevestiging) -->
<div id="deleteMemberConfirmModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:450px;">
    <div class="modal-header">
      <h2>Deelnemer Verwijderen</h2>
      <span class="modal-close" onclick="closeDeleteMemberConfirmModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p id="deleteMemberConfirmMessage" style="margin-bottom: 20px; font-size: 15px; line-height: 1.5;">
        Weet je zeker dat je deze deelnemer wilt verwijderen? Wijzigingen zijn permanent en kunnen niet ongedaan gemaakt worden.
      </p>
      <form id="deleteMemberConfirmForm" method="POST" action="{{ url_for('main.delete_member') }}">
        <input type="hidden" name="member_id" id="deleteMemberIdHidden">
        <div class="form-actions">
          <button type="button" class="btn ghost" onclick="closeDeleteMemberConfirmModal()">Annuleren</button>
          <button type="submit" class="btn" style="background: #d32f2f; color: white;">Bevestigen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function updateFormFields() {
    const role = document.getElementById('addMemberRole').value;
    const functionGroup = document.getElementById('functionGroup');
    const sectorGroup = document.getElementById('sectorGroup');
    const functionSelect = document.getElementById('addMemberFunction');
    const sectorSelect = document.getElementById('addMemberSector');
    
    // Reset required attributes
    functionSelect.removeAttribute('required');
    sectorSelect.removeAttribute('required');
    
    if (role === 'board') {
        functionGroup.style.display = 'block';
        functionSelect.setAttribute('required', 'required');
        sectorGroup.style.display = 'none';
    } else if (role === 'analist') {
        functionGroup.style.display = 'none';
        sectorGroup.style.display = 'block';
        sectorSelect.setAttribute('required', 'required');
    } else {
        functionGroup.style.display = 'none';
        sectorGroup.style.display = 'block';
    }
}

function closeAddMemberModal() {
    document.getElementById('addMemberForm').style.display = 'none';
    document.getElementById('addMemberFormSubmit').reset();
    // Reset form fields visibility
    updateFormFields();
}

function openEditMemberModal() {
    document.getElementById('editMemberModal').style.display = 'flex';
}

function closeEditMemberModal() {
    document.getElementById('editMemberModal').style.display = 'none';
    document.getElementById('editMemberIdInput').value = '';
}

function closeEditMemberFormModal() {
    document.getElementById('editMemberFormModal').style.display = 'none';
    closeEditMemberModal();
}

async function fetchMemberForEditing(event) {
    event.preventDefault();
    const memberId = parseInt(document.getElementById('editMemberIdInput').value);
    
    if (!memberId || memberId < 1) {
        alert('Voer een geldig ID nummer in.');
        return;
    }
    
    try {
        const response = await fetch(`/deelnemers/get-member/${memberId}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // Vul formulier in
        document.getElementById('editMemberIdHidden').value = data.member_id;
        document.getElementById('editMemberIdDisplay').value = String(data.member_id).padStart(6, '0');
        document.getElementById('editMemberName').value = data.member_name || '';
        // Set functie dropdown value
        const functionSelect = document.getElementById('editMemberFunction');
        if (data.voting_right) {
            functionSelect.value = data.voting_right;
        } else {
            functionSelect.value = '';
        }
        document.getElementById('editMemberEmail').value = data.email || '';
        document.getElementById('editMemberSector').value = data.sector || '';
        document.getElementById('editMemberStartYear').value = data.join_date || '';
        
        // Toon edit form modal
        document.getElementById('editMemberModal').style.display = 'none';
        document.getElementById('editMemberFormModal').style.display = 'flex';
    } catch (error) {
        console.error('Error:', error);
        alert('Er is een fout opgetreden bij het ophalen van de deelnemer gegevens.');
    }
}

function openDeleteMemberModal() {
    document.getElementById('deleteMemberModal').style.display = 'flex';
}

function closeDeleteMemberModal() {
    document.getElementById('deleteMemberModal').style.display = 'none';
    document.getElementById('deleteMemberIdInput').value = '';
}

function closeDeleteMemberConfirmModal() {
    document.getElementById('deleteMemberConfirmModal').style.display = 'none';
    closeDeleteMemberModal();
}

async function fetchMemberForDeletion(event) {
    event.preventDefault();
    const memberId = parseInt(document.getElementById('deleteMemberIdInput').value);
    
    if (!memberId || memberId < 1) {
        alert('Voer een geldig ID nummer in.');
        return;
    }
    
    try {
        const response = await fetch(`/deelnemers/get-member/${memberId}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // Toon bevestigingsbericht met alle gegevens
        const idStr = String(data.member_id).padStart(6, '0');
        const message = `Weet je zeker dat je deze deelnemer wilt verwijderen?\n\n` +
                       `ID Nummer: ${idStr}\n` +
                       `Naam: ${data.member_name || 'Onbekend'}\n` +
                       `Email: ${data.email || 'Geen email'}\n\n` +
                       `Wijzigingen zijn permanent en kunnen niet ongedaan gemaakt worden.`;
        
        document.getElementById('deleteMemberConfirmMessage').textContent = message;
        document.getElementById('deleteMemberIdHidden').value = data.member_id;
        
        // Toon bevestigingsmodal
        document.getElementById('deleteMemberModal').style.display = 'none';
        document.getElementById('deleteMemberConfirmModal').style.display = 'flex';
    } catch (error) {
        console.error('Error:', error);
        alert('Er is een fout opgetreden bij het ophalen van de deelnemer gegevens.');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addMemberForm');
    const editModal = document.getElementById('editMemberModal');
    const editFormModal = document.getElementById('editMemberFormModal');
    const deleteModal = document.getElementById('deleteMemberModal');
    const deleteConfirmModal = document.getElementById('deleteMemberConfirmModal');
    
    if (event.target == addModal) {
        closeAddMemberModal();
    }
    if (event.target == editModal) {
        closeEditMemberModal();
    }
    if (event.target == editFormModal) {
        closeEditMemberFormModal();
    }
    if (event.target == deleteModal) {
        closeDeleteMemberModal();
    }
    if (event.target == deleteConfirmModal) {
        closeDeleteMemberConfirmModal();
    }
}
</script>
{% endblock %}

