{% extends "logged_in_base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block sub_content %}
<div class="dashboard-grid">
  <section class="leftcol card">
    <div class="section-head">
      <h3>Aankondigingen</h3>
      <button class="add-transaction-btn" type="button" onclick="openAnnouncementModal()">
        + Bericht toevoegen
      </button>
    </div>

    {% for post in announcements %}
    <article class="announcement">
      <h4>{{ post.title }}</h4>
      <p>{{ post.body }}</p>
      <div class="meta">{{ post.date }} • {{ post.author }}</div>
    </article>
    {% endfor %}
  </section>

  <aside class="rightcol card">
    <!-- AGENDA LAYOUT: header met acties (alleen iconen) -->
    <div class="section-head">
      <h3>Agenda</h3>
      <div class="agenda-actions">
        <button class="agenda-add-btn" type="button" onclick="openEventModal()" title="Event toevoegen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
        <button class="agenda-edit-btn" type="button" onclick="openEditEventModal()" title="Event wijzigen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        </button>
        <button class="agenda-delete-btn" type="button" onclick="openDeleteEventModal()" title="Event verwijderen">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          </svg>
        </button>
        <a href="{{ url_for('main.export_all_events_ical') }}" class="agenda-ical-btn" title="iCal Exporteren">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </a>
      </div>
    </div>

    <!-- AGENDA LAYOUT: Toekomstige Events -->
    <section class="agenda-section">
      <div class="agenda-section-title">Toekomstige Events</div>
      {% if upcoming_events %}
        {% for ev in upcoming_events %}
        <div class="agenda-event-card">
          <strong>{{ ev.title }}</strong>
          <div class="muted">{{ ev.date }} • {{ ev.time }}</div>
          <div class="muted">{{ ev.location }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="agenda-empty muted">Geen toekomstige events</div>
      {% endif %}
    </section>

    <!-- AGENDA LAYOUT: Vandaag -->
    <section class="agenda-section">
      <div class="agenda-section-title">{{ today_label }}</div>
      {% if today_events %}
        {% for ev in today_events %}
        <div class="agenda-event-card">
          <strong>{{ ev.title }}</strong>
          <div class="muted">{{ ev.date }} • {{ ev.time }}</div>
          <div class="muted">{{ ev.location }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="agenda-empty muted">Geen events vandaag</div>
      {% endif %}
    </section>

    <!-- AGENDA LAYOUT: Voorbije Events -->
    <section class="agenda-section">
      <div class="agenda-section-title">Voorbije Events</div>
      {% if past_events %}
        {% for ev in past_events %}
        <div class="agenda-event-card agenda-event-past">
          <strong>{{ ev.title }}</strong>
          <div class="muted">{{ ev.date }} • {{ ev.time }}</div>
          <div class="muted">{{ ev.location }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="agenda-empty muted">Geen voorbije events</div>
      {% endif %}
    </section>

  </aside>
</div>

<!-- Announcement Modal -->
<div id="announcementModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2>Nieuwe Aankondiging</h2>
      <span class="modal-close" onclick="closeAnnouncementModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px; color: var(--muted);">Voeg een nieuwe aankondiging toe.</p>
      <form method="post" action="{{ url_for('main.add_announcement') }}">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" id="announcementTitle" placeholder="Voer de titel in" required>
        </div>
        <div class="form-group">
          <label>Bericht *</label>
          <textarea name="body" id="announcementBody" rows="4" placeholder="Voer het bericht in" required></textarea>
        </div>
        <div class="form-group">
          <label>Datum</label>
          <input type="text" id="announcementDate" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>Auteur</label>
          <input type="text" value="{{ g.user.member_name if g.user else 'Onbekend' }}" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="btn ghost" onclick="closeAnnouncementModal()">Annuleren</button>
          <button type="submit" class="btn add-transaction-btn" style="background: var(--cta); color: white; border: none;">Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Event Modal -->
<div id="eventModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2>Event Toevoegen</h2>
      <span class="modal-close" onclick="closeEventModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px; color: var(--muted);">Voeg een nieuw event toe aan de agenda.</p>
      <form method="post" action="{{ url_for('main.add_event') }}">
        <div class="form-group">
          <label>Event titel *</label>
          <input type="text" name="title" id="eventTitle" placeholder="Event titel" required>
        </div>
        <div class="form-group">
          <label>mededeling (optioneel)</label>
          <textarea name="message" id="eventMessage" rows="3" placeholder="Extra informatie over het event"></textarea>
        </div>
        <div class="form-group">
          <label>Datum</label>
          <input type="text" name="date" id="eventDate" placeholder="dd/mm/yyyy">
        </div>
        <div class="form-group">
          <label>Start uur</label>
          <input type="text" name="time" id="eventTime" placeholder="--:--">
        </div>
        <div class="form-group">
          <label>locatie (optioneel)</label>
          <input type="text" name="location" id="eventLocation" placeholder="Event locatie">
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="btn ghost" onclick="closeEventModal()">Annuleren</button>
          <button type="submit" class="btn add-transaction-btn" style="background: var(--cta); color: white; border: none;">Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Event Modal (stap 1: dropdown selecteren) -->
<div id="editEventModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <h2>Event Wijzigen</h2>
      <span class="modal-close" onclick="closeEditEventModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editEventForm" onsubmit="fetchEventForEditing(event)">
        <div class="form-group">
          <label>Selecteer Event *</label>
          <select name="event_number" id="editEventSelect" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
            <option value="">Laden...</option>
          </select>
          <small style="color: #666; font-size: 12px;">Selecteer het event dat je wilt wijzigen</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn">Volgende</button>
          <button type="button" class="btn ghost" onclick="closeEditEventModal()">Annuleren</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Event Form Modal (stap 2: formulier) -->
<div id="editEventFormModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2>Event Wijzigen</h2>
      <span class="modal-close" onclick="closeEditEventFormModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px; color: var(--muted); font-size: 14px;">Pas het event aan.</p>
      <form id="editEventFormSubmit" method="POST" action="{{ url_for('main.update_event') }}">
        <input type="hidden" name="event_number" id="editEventNumber">
        <div class="form-group">
          <label>Event titel *</label>
          <input type="text" name="event_name" id="editEventName" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
        </div>
        <div class="form-group">
          <label>Datum *</label>
          <input type="text" name="event_date" id="editEventDate" required placeholder="dd/mm/yyyy" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
        </div>
        <div class="form-group">
          <label>Start uur *</label>
          <input type="text" name="event_time" id="editEventTime" required placeholder="HH:MM" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
        </div>
        <div class="form-group">
          <label>Locatie (optioneel)</label>
          <input type="text" name="location" id="editEventLocation" placeholder="Event locatie" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
        </div>
        <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn ghost" onclick="closeEditEventFormModal()">Annuleren</button>
          <button type="submit" class="btn" style="background: #ff9800; color: white; padding: 10px 20px;">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Event Modal (stap 1: dropdown selecteren) -->
<div id="deleteEventModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <h2>Event Verwijderen</h2>
      <span class="modal-close" onclick="closeDeleteEventModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="deleteEventForm" onsubmit="fetchEventForDeletion(event)">
        <div class="form-group">
          <label>Selecteer Event *</label>
          <select name="event_number" id="deleteEventSelect" required style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
            <option value="">Laden...</option>
          </select>
          <small style="color: #666; font-size: 12px;">Selecteer het event dat je wilt verwijderen</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn" style="background: #f44336; color: white;">Volgende</button>
          <button type="button" class="btn ghost" onclick="closeDeleteEventModal()">Annuleren</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Event Confirmation Modal (stap 2: bevestiging) -->
<div id="deleteEventConfirmModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h2>Event Verwijderen Bevestigen</h2>
      <span class="modal-close" onclick="closeDeleteEventConfirmModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px; color: var(--muted);">Weet je zeker dat je dit event wilt verwijderen?</p>
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
        <strong id="deleteEventNameDisplay"></strong>
        <div style="margin-top: 5px; font-size: 14px; color: #666;" id="deleteEventDetailsDisplay"></div>
      </div>
      <form id="deleteEventConfirmForm" method="POST" action="{{ url_for('main.delete_event') }}">
        <input type="hidden" name="event_number" id="deleteEventNumber">
        <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" class="btn ghost" onclick="closeDeleteEventConfirmModal()">Annuleren</button>
          <button type="submit" class="btn" style="background: #f44336; color: white; padding: 10px 20px;">Verwijderen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function openAnnouncementModal() {
    const modal = document.getElementById('announcementModal');
    modal.style.display = 'flex';
    // Set current date
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    document.getElementById('announcementDate').value = `${day}-${month}-${year}`;
}

function closeAnnouncementModal() {
    document.getElementById('announcementModal').style.display = 'none';
    document.getElementById('announcementTitle').value = '';
    document.getElementById('announcementBody').value = '';
}

function openEventModal() {
    document.getElementById('eventModal').style.display = 'flex';
}

function closeEventModal() {
    document.getElementById('eventModal').style.display = 'none';
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventMessage').value = '';
    document.getElementById('eventDate').value = '';
    document.getElementById('eventTime').value = '';
    document.getElementById('eventLocation').value = '';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const announcementModal = document.getElementById('announcementModal');
    const eventModal = document.getElementById('eventModal');
    const editEventModal = document.getElementById('editEventModal');
    const editEventFormModal = document.getElementById('editEventFormModal');
    const deleteEventModal = document.getElementById('deleteEventModal');
    const deleteEventConfirmModal = document.getElementById('deleteEventConfirmModal');
    
    if (event.target == announcementModal) {
        closeAnnouncementModal();
    }
    if (event.target == eventModal) {
        closeEventModal();
    }
    if (event.target == editEventModal) {
        closeEditEventModal();
    }
    if (event.target == editEventFormModal) {
        closeEditEventFormModal();
    }
    if (event.target == deleteEventModal) {
        closeDeleteEventModal();
    }
    if (event.target == deleteEventConfirmModal) {
        closeDeleteEventConfirmModal();
    }
}

// Edit Event Modal Functions
function openEditEventModal() {
    const modal = document.getElementById('editEventModal');
    const select = document.getElementById('editEventSelect');
    modal.style.display = 'flex';
    
    // Load events into dropdown
    fetch('/events/get-all')
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="">Selecteer een event...</option>';
            if (data.events && data.events.length > 0) {
                data.events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.event_number;
                    option.textContent = event.display;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">Geen events beschikbaar</option>';
            }
        })
        .catch(error => {
            console.error('Error loading events:', error);
            select.innerHTML = '<option value="">Fout bij laden van events</option>';
        });
}

function closeEditEventModal() {
    document.getElementById('editEventModal').style.display = 'none';
    document.getElementById('editEventSelect').value = '';
}

function closeEditEventFormModal() {
    document.getElementById('editEventFormModal').style.display = 'none';
    closeEditEventModal(); // Also close the first modal
}

function fetchEventForEditing(event) {
    event.preventDefault();
    const eventNumber = document.getElementById('editEventSelect').value;
    
    if (!eventNumber) {
        alert('Selecteer eerst een event.');
        return;
    }
    
    fetch(`/events/get-details/${eventNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Fill form with event data
            document.getElementById('editEventNumber').value = data.event_number;
            document.getElementById('editEventName').value = data.event_name;
            document.getElementById('editEventDate').value = data.event_date;
            document.getElementById('editEventTime').value = data.event_time;
            document.getElementById('editEventLocation').value = data.location || '';
            
            // Close first modal and open form modal
            closeEditEventModal();
            document.getElementById('editEventFormModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching event details:', error);
            alert('Fout bij ophalen van event details.');
        });
}

// Delete Event Modal Functions
function openDeleteEventModal() {
    const modal = document.getElementById('deleteEventModal');
    const select = document.getElementById('deleteEventSelect');
    modal.style.display = 'flex';
    
    // Load events into dropdown
    fetch('/events/get-all')
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="">Selecteer een event...</option>';
            if (data.events && data.events.length > 0) {
                data.events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.event_number;
                    option.textContent = event.display;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">Geen events beschikbaar</option>';
            }
        })
        .catch(error => {
            console.error('Error loading events:', error);
            select.innerHTML = '<option value="">Fout bij laden van events</option>';
        });
}

function closeDeleteEventModal() {
    document.getElementById('deleteEventModal').style.display = 'none';
    document.getElementById('deleteEventSelect').value = '';
}

function closeDeleteEventConfirmModal() {
    document.getElementById('deleteEventConfirmModal').style.display = 'none';
    closeDeleteEventModal(); // Also close the first modal
}

function fetchEventForDeletion(event) {
    event.preventDefault();
    const eventNumber = document.getElementById('deleteEventSelect').value;
    
    if (!eventNumber) {
        alert('Selecteer eerst een event.');
        return;
    }
    
    fetch(`/events/get-details/${eventNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Fill confirmation modal with event data
            document.getElementById('deleteEventNumber').value = data.event_number;
            document.getElementById('deleteEventNameDisplay').textContent = data.event_name;
            document.getElementById('deleteEventDetailsDisplay').textContent = `${data.event_date} ${data.event_time} - ${data.location || 'Geen locatie'}`;
            
            // Close first modal and open confirmation modal
            closeDeleteEventModal();
            document.getElementById('deleteEventConfirmModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching event details:', error);
            alert('Fout bij ophalen van event details.');
        });
}
</script>
{% endblock %}
