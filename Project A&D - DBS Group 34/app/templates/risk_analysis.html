{% extends "logged_in_base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block sub_content %}
<div class="card">
  <div class="section-head">
    <h3>Risico-analyse</h3>
    <button class="btn" onclick="loadRiskAnalysis()" id="riskAnalysisBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
        <path d="M2 17l10 5 10-5"></path>
        <path d="M2 12l10 5 10-5"></path>
      </svg>
      Risico-analyse uitvoeren
    </button>
  </div>

  <!-- Risk Analysis Results -->
  <div id="riskAnalysisResults" style="display: none; padding: 20px;">
    <div id="riskAnalysisLoading" style="text-align: center; padding: 40px;">
      <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--green); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin-top: 15px; color: var(--muted);">Risico-analyse wordt uitgevoerd...</p>
    </div>
    <div id="riskAnalysisContent" style="display: none;">
      <!-- Content wordt hier ingevuld via JavaScript -->
    </div>
  </div>
</div>

<style>
/* Risk Analysis Styles - gebruikt main.css variabelen */
.risk-analysis-header {
  margin-bottom: 30px;
}

.risk-overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.risk-metric-card {
  background: #f8fffc;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
}

.risk-metric-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.risk-metric-card.large {
  grid-column: span 2;
}

.risk-metric-label {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.risk-metric-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--green);
  margin-bottom: 5px;
}

.risk-metric-value.large-value {
  font-size: 36px;
}

.risk-metric-value.positive {
  color: #2e7d32;
}

.risk-metric-value.negative {
  color: #c62828;
}

.risk-metric-hint {
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
  font-style: italic;
}

.risk-metric-percentage {
  font-size: 14px;
  color: var(--muted);
  margin-top: 5px;
  font-weight: 500;
}

.risk-level-card {
  background: linear-gradient(135deg, #f8fffc 0%, #e8f5e9 100%);
  border: 2px solid var(--border);
}

.risk-level-card.risk-level-low {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  border-color: #2e7d32;
}

.risk-level-card.risk-level-medium {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border-color: #f57c00;
}

.risk-level-card.risk-level-high {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  border-color: #c62828;
}

.risk-level-badge {
  font-size: 32px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.risk-level-card.risk-level-low .risk-level-badge {
  color: #2e7d32;
}

.risk-level-card.risk-level-medium .risk-level-badge {
  color: #f57c00;
}

.risk-level-card.risk-level-high .risk-level-badge {
  color: #c62828;
}

.risk-section {
  margin-bottom: 40px;
  padding: 25px;
  background: #fafafa;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.risk-section-header {
  margin-bottom: 20px;
}

.risk-section-header h4 {
  color: var(--green);
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 600;
}

.risk-section-description {
  color: var(--muted);
  font-size: 14px;
  margin: 0;
  line-height: 1.6;
}

.risk-metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.var-card {
  background: linear-gradient(135deg, #fff 0%, #f0f7f4 100%);
}

.score-card {
  text-align: left;
}

.score-display {
  margin: 15px 0;
}

.score-value {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 10px;
}

.score-bar-container {
  width: 100%;
  height: 12px;
  background: #e0e0e0;
  border-radius: 6px;
  overflow: hidden;
}

.score-bar {
  height: 100%;
  border-radius: 6px;
  transition: width 0.5s ease;
}

.score-bar.positive {
  background: linear-gradient(90deg, #2e7d32 0%, #43A047 100%);
}

.score-bar.negative {
  background: linear-gradient(90deg, #c62828 0%, #e53935 100%);
}

.sector-allocation-section {
  margin-top: 25px;
  padding-top: 25px;
  border-top: 1px solid var(--border);
}

.sector-allocation-title {
  color: var(--green);
  margin: 0 0 15px 0;
  font-size: 16px;
  font-weight: 600;
}

.sector-allocation-grid {
  display: grid;
  gap: 12px;
}

.sector-allocation-item {
  background: white;
  padding: 12px 15px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.sector-allocation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.sector-name {
  font-weight: 600;
  color: var(--green);
  font-size: 14px;
}

.sector-weight {
  font-weight: 700;
  color: var(--green);
  font-size: 14px;
}

.sector-bar-container {
  width: 100%;
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  overflow: hidden;
}

.sector-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.top-positions-table {
  margin-top: 15px;
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: white;
}

.positions-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.positions-table thead {
  background: #f8f9fa;
}

.positions-table th {
  padding: 12px 10px;
  text-align: left;
  font-weight: 600;
  color: var(--green);
  border-bottom: 2px solid var(--border);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.positions-table td {
  padding: 12px 10px;
  border-bottom: 1px solid #f0f0f0;
}

.positions-table tbody tr:hover {
  background: #f8fffc;
}

.positions-table tbody tr:last-child td {
  border-bottom: none;
}

.ticker-cell {
  font-weight: 600;
  color: var(--green);
}

.value-cell {
  font-weight: 600;
  color: var(--green);
}

.weight-cell {
  color: var(--muted);
  font-size: 13px;
}

.vol-cell {
  font-weight: 500;
}

.vol-cell.positive {
  color: #2e7d32;
}

.vol-cell.negative {
  color: #c62828;
}


.risk-error {
  text-align: center;
  padding: 30px;
  background: #ffebee;
  border-radius: var(--radius);
  border: 1px solid #ffcdd2;
}

.risk-error p {
  color: #c62828;
  margin: 0;
  font-weight: 500;
}

/* Benchmark Comparison Styles */
.benchmark-comparison-table-wrapper {
  margin-top: 20px;
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: white;
}

.benchmark-comparison-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.benchmark-comparison-table thead {
  background: linear-gradient(135deg, var(--green) 0%, var(--green-2) 100%);
  color: white;
}

.benchmark-comparison-table th {
  padding: 14px 12px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.benchmark-comparison-table th.benchmark-rank {
  width: 50px;
  text-align: center;
}

.benchmark-comparison-table th.benchmark-name {
  width: auto;
}

.benchmark-comparison-table th.benchmark-metric {
  width: 120px;
  text-align: right;
}

.benchmark-comparison-table tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background-color 0.2s;
}

.benchmark-comparison-table tbody tr:hover {
  background: #f8fffc;
}

.benchmark-comparison-table tbody tr.benchmark-row-vek {
  background: linear-gradient(135deg, rgba(37, 91, 72, 0.05) 0%, rgba(37, 91, 72, 0.02) 100%);
  font-weight: 600;
}

.benchmark-comparison-table tbody tr.benchmark-row-vek:hover {
  background: linear-gradient(135deg, rgba(37, 91, 72, 0.1) 0%, rgba(37, 91, 72, 0.05) 100%);
}

.benchmark-comparison-table td {
  padding: 12px;
  vertical-align: middle;
}

.benchmark-comparison-table td.benchmark-rank {
  text-align: center;
  font-weight: 700;
  font-size: 16px;
}

.benchmark-comparison-table td.benchmark-rank.benchmark-rank-first {
  color: #f57c00;
  font-weight: 700;
}

/* Loss color classes */
.loss-critical {
  color: #c62828 !important;
  font-weight: 600;
}

.loss-high {
  color: #e65100 !important;
  font-weight: 600;
}

.loss-medium {
  color: #f57c00 !important;
  font-weight: 600;
}

.loss-low {
  color: #ff9800 !important;
  font-weight: 500;
}

/* Severity classes */
.severity-critical {
  color: #c62828;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
}

.severity-high {
  color: #e65100;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
}

.severity-medium {
  color: #f57c00;
  font-weight: 500;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
}

.severity-low {
  color: #ff9800;
  font-weight: 500;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
}

.benchmark-comparison-table td.benchmark-name {
  font-weight: 500;
}

.benchmark-comparison-table td.benchmark-metric {
  text-align: right;
  font-family: 'Courier New', monospace;
  font-weight: 600;
}

.benchmark-legend {
  margin-top: 15px;
  padding: 12px;
  background: #f8fffc;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  text-align: center;
}

.benchmark-legend-text {
  margin: 0;
  font-size: 13px;
  color: var(--muted);
  line-height: 1.6;
}

.positive {
  color: #2e7d32;
  font-weight: 600;
}

.negative {
  color: #c62828;
  font-weight: 600;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .risk-overview-grid {
    grid-template-columns: 1fr;
  }
  
  .risk-metric-card.large {
    grid-column: span 1;
  }
  
  .risk-metrics-grid {
    grid-template-columns: 1fr;
  }
  
  
  .positions-table {
    font-size: 12px;
  }
  
  .positions-table th,
  .positions-table td {
    padding: 8px 6px;
  }
}
</style>

<script>
// Risk Analysis Functions
async function loadRiskAnalysis() {
  const resultsDiv = document.getElementById('riskAnalysisResults');
  const loadingDiv = document.getElementById('riskAnalysisLoading');
  const contentDiv = document.getElementById('riskAnalysisContent');
  const btn = document.getElementById('riskAnalysisBtn');
  
  resultsDiv.style.display = 'block';
  loadingDiv.style.display = 'block';
  contentDiv.style.display = 'none';
  btn.disabled = true;
  btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg> Laden...';
  
  try {
    const response = await fetch('/portfolio/risk-analysis');
    const data = await response.json();
    
    if (data.success) {
      displayRiskAnalysis(data.risk_summary);
    } else {
      showError('riskAnalysisContent', 'Kon risico-analyse niet uitvoeren: ' + (data.error || 'Onbekende fout'));
    }
  } catch (error) {
    showError('riskAnalysisContent', 'Fout bij ophalen risico-analyse: ' + error.message);
  } finally {
    loadingDiv.style.display = 'none';
    contentDiv.style.display = 'block';
    btn.disabled = false;
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg> Risico-analyse uitvoeren';
  }
}

function displayRiskAnalysis(summary) {
  const contentDiv = document.getElementById('riskAnalysisContent');
  
  let html = '<div class="risk-analysis-header">';
  html += '<div class="risk-overview-grid">';
  
  html += `<div class="risk-metric-card large">
    <div class="risk-metric-label">Portfolio Waarde</div>
    <div class="risk-metric-value large-value">€ ${formatNumber(summary.portfolio_value || 0)}</div>
    ${summary.position_value ? `<div class="risk-metric-hint">Posities: € ${formatNumber(summary.position_value)} | Cash: € ${formatNumber(summary.cash_amount || 0)}</div>` : ''}
  </div>`;
  
  html += `<div class="risk-metric-card">
    <div class="risk-metric-label">Aantal Posities</div>
    <div class="risk-metric-value">${summary.num_positions || 0}</div>
    <div class="risk-metric-hint">Actieve posities</div>
  </div>`;
  
  if (summary.cash_percentage !== null && summary.cash_percentage !== undefined) {
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">Cash Percentage</div>
      <div class="risk-metric-value">${summary.cash_percentage.toFixed(1)}%</div>
      <div class="risk-metric-hint">${summary.cash_percentage > 20 ? 'Hoog cash niveau' : summary.cash_percentage > 10 ? 'Matig cash niveau' : 'Laag cash niveau'}</div>
    </div>`;
  }
  
  const riskLevel = (summary.risk_level || 'Unknown').toLowerCase();
  const riskLevelText = summary.risk_level || 'Unknown';
  html += `<div class="risk-metric-card risk-level-card risk-level-${riskLevel}">
    <div class="risk-metric-label">Risico Niveau</div>
    <div class="risk-metric-value risk-level-badge">${riskLevelText}</div>
    <div class="risk-metric-hint">${getRiskLevelDescription(riskLevel)}</div>
  </div>`;
  
  if (summary.volatility !== null && summary.volatility !== undefined) {
    const volColor = getRiskColorClass(summary.volatility, 10, 20);
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">Volatiliteit (Jaarlijks)</div>
      <div class="risk-metric-value ${volColor}">${summary.volatility.toFixed(2)}%</div>
      <div class="risk-metric-hint">${getVolatilityDescription(summary.volatility)}</div>
    </div>`;
  }
  
  if (summary.sharpe_ratio !== null && summary.sharpe_ratio !== undefined) {
    const sharpeColor = summary.sharpe_ratio > 1 ? 'positive' : summary.sharpe_ratio > 0 ? '' : 'negative';
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">Sharpe Ratio</div>
      <div class="risk-metric-value ${sharpeColor}">${summary.sharpe_ratio.toFixed(2)}</div>
      <div class="risk-metric-hint">${summary.sharpe_ratio > 1 ? 'Uitstekend' : summary.sharpe_ratio > 0 ? 'Goed' : 'Laag'}</div>
    </div>`;
  }
  
  html += '</div></div>';
  
  if (summary.var_95) {
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Value at Risk (VaR)</h4>';
    html += '<p class="risk-section-description">De maximale verwachte verlieswaarde binnen een bepaald betrouwbaarheidsniveau</p>';
    html += '</div>';
    html += '<div class="risk-metrics-grid">';
    
    const var95Pct = summary.var_95.var_percentage_of_portfolio || summary.var_95.var_percentage || 0;
    const var95Abs = summary.var_95.var_absolute || 0;
    html += `<div class="risk-metric-card var-card">
      <div class="risk-metric-label">VaR (95% Confidence)</div>
      <div class="risk-metric-value ${var95Pct > 3 ? 'negative' : var95Pct > 1.5 ? '' : 'positive'}">€ ${formatNumber(var95Abs)}</div>
      <div class="risk-metric-percentage">${var95Pct.toFixed(2)}% van portfolio</div>
      <div class="risk-metric-hint">95% kans dat verlies ≤ dit bedrag</div>
    </div>`;
    
    if (summary.var_99) {
      const var99Pct = summary.var_99.var_percentage_of_portfolio || summary.var_99.var_percentage || 0;
      const var99Abs = summary.var_99.var_absolute || 0;
      html += `<div class="risk-metric-card var-card">
        <div class="risk-metric-label">VaR (99% Confidence)</div>
        <div class="risk-metric-value ${var99Pct > 3 ? 'negative' : var99Pct > 1.5 ? '' : 'positive'}">€ ${formatNumber(var99Abs)}</div>
        <div class="risk-metric-percentage">${var99Pct.toFixed(2)}% van portfolio</div>
        <div class="risk-metric-hint">99% kans dat verlies ≤ dit bedrag</div>
      </div>`;
    }
    
    html += '</div></div>';
  }
  
  if (summary.diversification) {
    const div = summary.diversification;
    const divScore = div.score || 0;
    
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Diversificatie Analyse</h4>';
    html += '<p class="risk-section-description">Hoe goed gespreid is je portfolio over verschillende posities? (Sector spreiding wordt getoond in portfolio tabblad)</p>';
    html += '</div>';
    
    html += '<div class="risk-metrics-grid">';
    
    html += `<div class="risk-metric-card score-card">
      <div class="risk-metric-label">Diversificatie Score</div>
      <div class="score-display">
        <div class="score-value ${getScoreColorClass(divScore)}">${divScore}/100</div>
        <div class="score-bar-container">
          <div class="score-bar ${getScoreColorClass(divScore)}" style="width: ${divScore}%"></div>
        </div>
      </div>
      <div class="risk-metric-hint">${getDiversificationDescription(divScore)}</div>
    </div>`;
    
    const maxWeight = (div.max_weight || 0) * 100;
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">Grootste Positie</div>
      <div class="risk-metric-value ${maxWeight > 30 ? 'negative' : maxWeight > 15 ? '' : 'positive'}">${maxWeight.toFixed(1)}%</div>
      <div class="risk-metric-hint">${maxWeight > 30 ? 'Te geconcentreerd' : maxWeight > 15 ? 'Matig geconcentreerd' : 'Goed gespreid'}</div>
    </div>`;
    
    html += '</div></div>';
  }
  
  // Max Drawdown
  if (summary.max_drawdown) {
    const mdd = summary.max_drawdown;
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Maximum Drawdown</h4>';
    html += '<p class="risk-section-description">Grootste daling van piek naar dal in de afgelopen periode</p>';
    html += '</div>';
    html += '<div class="risk-metrics-grid">';
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">MDD Percentage</div>
      <div class="risk-metric-value negative">${mdd.mdd_percentage?.toFixed(2) || 0}%</div>
      <div class="risk-metric-hint">${mdd.peak_date ? `Peak: ${mdd.peak_date}` : ''} ${mdd.trough_date ? `| Trough: ${mdd.trough_date}` : ''}</div>
    </div>`;
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">MDD Absoluut</div>
      <div class="risk-metric-value negative">€ ${formatNumber(mdd.mdd_absolute || 0)}</div>
      <div class="risk-metric-hint">Verlies in EUR</div>
    </div>`;
    html += '</div></div>';
  }
  
  // CVaR
  if (summary.cvar_95) {
    const cvar = summary.cvar_95;
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Conditional Value at Risk (CVaR)</h4>';
    html += '<p class="risk-section-description">Verwacht verlies gegeven dat VaR wordt overschreden (Expected Shortfall)</p>';
    html += '</div>';
    html += '<div class="risk-metrics-grid">';
    html += `<div class="risk-metric-card var-card">
      <div class="risk-metric-label">CVaR (95%)</div>
      <div class="risk-metric-value ${cvar.cvar_percentage > 5 ? 'negative' : cvar.cvar_percentage > 2 ? '' : 'positive'}">€ ${formatNumber(cvar.cvar_absolute || 0)}</div>
      <div class="risk-metric-percentage">${cvar.cvar_percentage?.toFixed(2) || 0}% van portfolio</div>
      <div class="risk-metric-hint">Verwacht verlies bij extreme events</div>
    </div>`;
    html += '</div></div>';
  }
  
  // Portfolio Beta
  if (summary.portfolio_beta !== null && summary.portfolio_beta !== undefined) {
    const beta = summary.portfolio_beta;
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Portfolio Beta</h4>';
    html += '<p class="risk-section-description">Gevoeligheid voor marktbewegingen (t.o.v. S&P 500)</p>';
    html += '</div>';
    html += '<div class="risk-metrics-grid">';
    html += `<div class="risk-metric-card">
      <div class="risk-metric-label">Beta</div>
      <div class="risk-metric-value ${beta > 1.2 ? 'negative' : beta < 0.8 ? 'positive' : ''}">${beta.toFixed(2)}</div>
      <div class="risk-metric-hint">${beta > 1 ? 'Volatieler dan markt' : beta < 1 ? 'Minder volatiel dan markt' : 'Gelijk aan markt'}</div>
    </div>`;
    html += '</div></div>';
  }
  
  // Stress Test
  if (summary.stress_test && summary.stress_test.scenarios && summary.stress_test.scenarios.length > 0) {
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Stress Test / Scenario Analyse</h4>';
    html += '<p class="risk-section-description">Impact van extreme marktgebeurtenissen op portfolio waarde</p>';
    html += '</div>';
    html += '<div class="top-positions-table">';
    html += '<table class="positions-table">';
    html += '<thead><tr>';
    html += '<th>Scenario</th><th>Beschrijving</th><th>Portfolio Waarde</th><th>Verlies</th><th>Severity</th>';
    html += '</tr></thead><tbody>';
    
    summary.stress_test.scenarios.forEach((scenario) => {
      // Bepaal kleur op basis van loss percentage
      const lossPct = scenario.loss_percentage || 0;
      let lossColorClass = '';
      if (lossPct >= 15) {
        lossColorClass = 'loss-critical'; // Rood
      } else if (lossPct >= 8) {
        lossColorClass = 'loss-high'; // Donker oranje
      } else if (lossPct >= 3) {
        lossColorClass = 'loss-medium'; // Oranje
      } else {
        lossColorClass = 'loss-low'; // Licht oranje
      }
      
      const severityClass = scenario.severity === 'Critical' ? 'severity-critical' : 
                           scenario.severity === 'High' ? 'severity-high' : 
                           scenario.severity === 'Medium' ? 'severity-medium' : 'severity-low';
      html += `<tr>
        <td class="ticker-cell"><strong>${scenario.name}</strong></td>
        <td>${scenario.description || ''}</td>
        <td class="value-cell">€ ${formatNumber(scenario.total_value_after || 0)}</td>
        <td class="value-cell ${lossColorClass}">€ ${formatNumber(scenario.loss_absolute || 0)} (${scenario.loss_percentage?.toFixed(2) || 0}%)</td>
        <td><span class="${severityClass}">${scenario.severity || 'Medium'}</span></td>
      </tr>`;
    });
    
    html += '</tbody></table></div></div>';
  }
  
  // Benchmark Vergelijking
  if (summary.benchmark_comparison && summary.benchmark_comparison.length > 0) {
    html += '<div class="risk-section">';
    html += '<div class="risk-section-header">';
    html += '<h4>Portefeuille Benchmark Vergelijking</h4>';
    html += '<p class="risk-section-description">Vergelijk je VEK portefeuille met drie benchmark strategieën op basis van rendement, volatiliteit en Sharpe ratio</p>';
    html += '</div>';
    
    html += '<div class="benchmark-comparison-table-wrapper">';
    html += '<table class="benchmark-comparison-table">';
    html += '<thead><tr>';
    html += '<th class="benchmark-rank">#</th>';
    html += '<th class="benchmark-name">Portefeuille</th>';
    html += '<th class="benchmark-metric">Rendement</th>';
    html += '<th class="benchmark-metric">Volatiliteit</th>';
    html += '<th class="benchmark-metric">Sharpe Ratio</th>';
    html += '</tr></thead><tbody>';
    
    summary.benchmark_comparison.forEach((benchmark, index) => {
      const isVek = benchmark.name === 'Huidige VEK Portefeuille';
      const rowClass = isVek ? 'benchmark-row-vek' : '';
      const rankClass = index === 0 ? 'benchmark-rank-first' : '';
      const sharpe = benchmark.sharpe_ratio;
      const sharpeColor = sharpe ? (sharpe > 1 ? 'positive' : sharpe > 0 ? '' : 'negative') : '';
      const sharpeStr = sharpe !== null && sharpe !== undefined ? sharpe.toFixed(3) : 'N/A';
      
      html += `<tr class="${rowClass}">`;
      html += `<td class="benchmark-rank ${rankClass}">${index + 1}</td>`;
      html += `<td class="benchmark-name"><strong>${isVek ? '[VEK] ' : ''}${benchmark.name}</strong></td>`;
      html += `<td class="benchmark-metric ${benchmark.annual_return >= 0 ? 'positive' : 'negative'}">${benchmark.annual_return.toFixed(2)}%</td>`;
      html += `<td class="benchmark-metric">${benchmark.volatility.toFixed(2)}%</td>`;
      html += `<td class="benchmark-metric ${sharpeColor}">${sharpeStr}</td>`;
      html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    html += '<div class="benchmark-legend">';
    html += '<p class="benchmark-legend-text"><strong>[VEK]</strong> = Jouw VEK Portefeuille | <strong>#1</strong> = Beste Sharpe Ratio</p>';
    html += '</div></div>';
  }
  
  contentDiv.innerHTML = html;
}

function formatNumber(num) {
  return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function getRiskColorClass(value, low, high) {
  if (value < low) return 'positive';
  if (value > high) return 'negative';
  return '';
}

function getScoreColorClass(score) {
  if (score >= 70) return 'positive';
  if (score < 40) return 'negative';
  return '';
}

function getRiskLevelDescription(level) {
  const descriptions = {
    'low': 'Laag risico - Conservatief portfolio',
    'medium': 'Gemiddeld risico - Gebalanceerd portfolio',
    'high': 'Hoog risico - Agressief portfolio',
    'unknown': 'Niet beschikbaar'
  };
  return descriptions[level] || descriptions['unknown'];
}

function getVolatilityDescription(vol) {
  if (vol < 10) return 'Zeer stabiel';
  if (vol < 15) return 'Stabiel';
  if (vol < 20) return 'Matig volatiel';
  if (vol < 30) return 'Volatiel';
  return 'Zeer volatiel';
}

function getDiversificationDescription(score) {
  if (score >= 80) return 'Uitstekend gediversifieerd';
  if (score >= 60) return 'Goed gediversifieerd';
  if (score >= 40) return 'Matig gediversifieerd';
  return 'Weinig gediversifieerd - overweeg meer spreiding';
}


function showError(elementId, message) {
  const element = document.getElementById(elementId);
  element.innerHTML = `<div class="risk-error"><p>${message}</p></div>`;
}
</script>
{% endblock %}

